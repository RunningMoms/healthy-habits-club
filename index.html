<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1, user-scalable=no">
    <title>Signup Page</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="fire_buttons.css" rel="stylesheet">
    <script>
        var TRAFFICJAM_DOMAIN = 'IO622801687';
        var STRIPE_KEY = 'pk_live_Hgrz280w9D3yOOPfipK2PaHr';
        var STRIPE_TITLE = 'Fitter Leaner Stronger';

        var offers = [
            {
                amount: 2997.00,
                currency: 'USD',
                label: 'Private Coaching',
                offer: 'IO311648704',
            },
            {
                amount: 497.00,
                currency: 'USD',
                label: 'Most Popular',
                offer: 'IO1083591651',
            },
            {
                amount: 197.00,
                currency: 'USD',
                label: 'Payment Plan',
                offer: 'IO129726425',
            }
        ];
    </script>
    <script src="//cdn.trafficjam.io/v1.js"></script>
    <style>
        /* Existing styles */
        body {
            background-image: url('media/_2024-12_squats.webp');
            background-size: cover;
            background-position: 65% 50%;
            height: 100vh;
            margin: 0;
            padding-bottom: 11em;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            overflow: hidden;
        }

        .modal-style {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
            max-width: 750px;
        }

        .modal-style input {
            background-color: white !important;
            font-weight: bold;
        }

        .offer-box {
            max-height: 45vh;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .offer-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        #actionButton {
            display: block;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 300px;
        }

        ul.stars {
            list-style: none; /* Remove default bullets */
            padding-left: 0; /* Optional: Remove left padding */
        }

        ul.stars li::before{
            content: '‚≠ê '; /* Add star emoji before each list item */
            font-size: 1.2em; /* Optional: Adjust emoji size */
        }
        ul.stars.aligned li{
            display: inline-block;
        }

        @media (min-width: 992px) {
            ul.stars.aligned::after{
                content: '‚≠ê '; /* Add star emoji before each list item */
                font-size: 1.2em; /* Optional: Adjust emoji size */
            }
        }

        .fine-print {
            font-size: 0.8rem; /* Adjust as needed */
            color: gray; /* Optional: make it a lighter color for de-emphasis */
        }

        /* Custom styles for Stripe Elements */
        .StripeElement {
            box-sizing: border-box;
            padding: 0.75rem 0.75rem;
            border: none;
            border-bottom: 1px solid #ced4da;
            background-color: transparent;
            margin-bottom: 0;
        }

        .StripeElement--focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: none;
        }

        /* Adjust the label for the card element */
        #card-element + label {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            pointer-events: none;
            transition: all 0.1s ease-in-out;
        }

        #card-element.StripeElement--focus + label,
        #card-element.not-empty + label {
            top: -0.5rem;
            left: 0.75rem;
            font-size: 0.85rem;
            opacity: 1;
        }

        /* Ensure the card element has a consistent height */
        #card-element {
            height: calc(3.5rem + 2px);
            border: 1px solid #ced4da;
            background-color: #ffffff;
        }

        /* Styles for the success modal */
        .success-box {
            max-height: 45vh;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: none; /* Initially hidden */
        }

        .success-box.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<div class="container d-flex justify-content-end">

    <button id="actionButton" class="btn btn-primary" onclick="actionButtonClick()">Loading...</button>

    <!-- Offer Box -->
    <div id="offerBox" class="offer-box modal-style w-75">

        <div class="modal-header text-center">
            <h2 class="display-5 w-100">
                <span style="white-space: nowrap;">Join Our</span>
                <span style="white-space: nowrap;">Healthy Habits Club</span>
            </h2>
        </div>
        <div class="modal-body">
            <p>Health doesn‚Äôt have to be complicated. Our club helps members stay on track while having fun.</p>

            <ul class="stars">
                <li>Fun Weekly Challenges</li>
                <li>Simple Healthy Recipes</li>
                <li>Supportive FB Community</li>
            </ul>

            <hr/>
            <h3><strong>December Challenges: Festive, Fun, and Healthy! üéÑ</strong></h3>

            <p>üéÑ <strong>Yuletide Yoga</strong>: Gentle stretches to destress this season.<br/>
                üéÖ <strong>Santa Squats</strong>: A quick lower-body strength boost.<br/>
                üé∂ <strong>Jingle Bell Jumps</strong>: Fun cardio bursts to energize your day.<br/>
                üéâ <strong>Christmas Crunches</strong>: Core-strengthening fun to stay active.</p>

            <p>PLUS, our <strong>Holiday Recipe Guide</strong> to make festive eating simple and guilt-free!</p>
        </div>
    </div>

    <!-- Signup Box with Stripe Payment Form -->
    <div id="signupBox" class="offer-box modal-style w-75" style="display: none;">
        <div class="modal-header text-center display-5">
            <h4 class=" w-100">HO-HO-HO-Heck YEAH!!!</h4>
        </div>
        <div class="modal-body">
            <ul class="stars fine-print" style="padding-left: 1.5em;">
                <li>Just $2USD/month.</li>
                <li>All payments are final.</li>
                <li>Cancel anytime.</li>
            </ul>
            <form id="payment-form">
                <!-- Email Field with Floating Label -->
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="modal-email" name="email" placeholder="Email Address" required>
                    <label for="modal-email">Email Address</label>
                </div>
                <!-- Name Field with Floating Label -->
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="modal-name" name="name" placeholder="Full Name" required>
                    <label for="modal-name">Full Name</label>
                </div>
                <!-- Card Element with Custom Floating Label -->
                <div class="form-floating mb-3 position-relative">
                    <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                    <div id="card-element" class="form-control" placeholder=" ">
                        <!-- Stripe's Card Element will be inserted here -->
                    </div>
                    <!-- Error Message -->
                </div>
            </form>
        </div>
    </div>

    <!-- Success/Thank-you Box -->
    <div id="successBox" class="success-box modal-style w-75">
        <div class="modal-header text-center">
            <h2 class="display-5 w-100">Thank You!</h2>
        </div>
        <div class="modal-body">
            <p>Your payment was successful, and you've joined the Healthy Habits Club!</p>
            <p>Check your email for confirmation and further details.</p>
            <p>We look forward to helping you on your wellness journey!</p>
        </div>
    </div>

</div>

<!-- Existing JavaScript -->
<script>
    // Replace isOffer boolean with currentStep variable
    var currentStep = 'offer'; // Possible values: 'offer', 'signup', 'success'

    const offerBox = document.getElementById("offerBox");
    const signupBox = document.getElementById("signupBox");
    const successBox = document.getElementById("successBox");
    const actionButton = document.getElementById("actionButton");

    function actionButtonClick() {
        switch (currentStep) {
            case 'offer':
                // Switch from offer to signup
                offerBox.classList.remove("show");
                setTimeout(() => {
                    offerBox.style.display = "none";
                    signupBox.style.display = "block";
                    setTimeout(() => signupBox.classList.add("show"), 10);
                }, 300); // Wait for hide animation
                actionButton.innerHTML = "Join Now";
                currentStep = 'signup';
                break;
            case 'signup':
                // If signup form is displayed, submit the payment
                actionButton.disabled = true; // Prevent multiple clicks
                actionButton.innerHTML = "Processing...";
                submitPayment();
                break;
            case 'success':
                // Optional: Define behavior when in success step
                // For example, redirect to another page
                window.location.href = '/welcome.html';
                break;
            default:
                break;
        }
    }

    window.onload = function () {
        setTimeout(function () {
            actionButton.innerHTML = "HO-HO-HO-Heck YEAH!!!";
            offerBox.classList.add("show");
        }, 250)
    };
</script>

<!-- Stripe Payment Script -->
<script>
    // Replace with your own publishable API key from Stripe Dashboard
    const stripe = Stripe('pk_test_SUBTHFPtvx5TceT6AuJdXoxb'); // <-- Replace with your publishable key

    // Create an instance of Elements
    const elements = stripe.elements();

    // Custom styling for the card element
    const style = {
        base: {
            color: '#000000',
            fontWeight: '400',
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSize: '16px',
            '::placeholder': {
                color: '#000000',
            },
        },
        invalid: {
            color: '#dc3545',
            iconColor: '#dc3545',
        },
    };

    // Create an instance of the card Element
    const card = elements.create('card', {style: style, hidePostalCode: true});

    // Add the card Element into the `card-element` <div>
    card.mount('#card-element');

    // Handle real-time validation errors
    card.on('change', function (event) {
        const displayError = document.getElementById('card-errors');
        const cardElementDiv = document.getElementById('card-element');

        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }

        // Add or remove 'not-empty' class based on card input
        if (event.complete || event.value) {
            cardElementDiv.classList.add('not-empty');
        } else {
            cardElementDiv.classList.remove('not-empty');
        }
    });

    // Handle focus events on the card element
    card.on('focus', function () {
        const cardElementDiv = document.getElementById('card-element');
        cardElementDiv.classList.add('StripeElement--focus');
    });

    card.on('blur', function () {
        const cardElementDiv = document.getElementById('card-element');
        cardElementDiv.classList.remove('StripeElement--focus');
    });

    function submitPayment() {
        const emailInput = document.getElementById('modal-email');
        const nameInput = document.getElementById('modal-name');

        // Simple validation
        if (!emailInput.value || !nameInput.value) {
            alert('Please fill out all required fields.');
            actionButton.disabled = false;
            actionButton.innerHTML = "Join Now";
            return;
        }

        stripe.createToken(card).then(function (result) {
            if (result.error) {
                // Inform the user if there was an error
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                actionButton.disabled = false;
                actionButton.innerHTML = "Join Now";
            } else {
                // Send the token and form data to your server
                stripeTokenHandler(result.token);
            }
        });
    }

    // Submit the token and additional data to your server
    function stripeTokenHandler(token) {
        const form = document.getElementById('payment-form');

        // Create hidden input elements for token and other data
        const hiddenTokenInput = document.createElement('input');
        hiddenTokenInput.setAttribute('type', 'hidden');
        hiddenTokenInput.setAttribute('name', 'stripeToken');
        hiddenTokenInput.setAttribute('value', token.id);
        form.appendChild(hiddenTokenInput);

        // Optionally, add email and name to the form data
        const emailInput = document.getElementById('modal-email');
        const nameInput = document.getElementById('modal-name');

        const hiddenEmailInput = document.createElement('input');
        hiddenEmailInput.setAttribute('type', 'hidden');
        hiddenEmailInput.setAttribute('name', 'email');
        hiddenEmailInput.setAttribute('value', emailInput.value);
        form.appendChild(hiddenEmailInput);

        const hiddenNameInput = document.createElement('input');
        hiddenNameInput.setAttribute('type', 'hidden');
        hiddenNameInput.setAttribute('name', 'name');
        hiddenNameInput.setAttribute('value', nameInput.value);
        form.appendChild(hiddenNameInput);

        // Submit the form to the server
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/charge', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Handle server response
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                actionButton.disabled = false;
                if (xhr.status === 200) {
                    // Payment successful
                    // Show success modal
                    signupBox.classList.remove("show");
                    setTimeout(() => {
                        signupBox.style.display = "none";
                        successBox.style.display = "block";
                        setTimeout(() => successBox.classList.add("show"), 10);
                    }, 300); // Wait for hide animation
                    actionButton.innerHTML = "Continue";
                    currentStep = 'success';
                } else {
                    // Payment failed
                    alert('Payment failed: ' + xhr.responseText);
                    actionButton.innerHTML = "Please Try Again";
                }
            }
        };

        // Collect form data
        const formData = new URLSearchParams(new FormData(form)).toString();

        // Send the form data
        xhr.send(formData);
    }
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
